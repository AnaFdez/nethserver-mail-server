#!/usr/bin/perl -w

#
# NethServer Mail Server events configuration
#
# Copyright (C) 2012 Nethesis srl
# See COPYING for licensing informations
#

use esmith::Build::CreateLinks qw(:all);
use File::Path;


# expanded templates on SAVE event
my @saveTemplates = qw(
    /etc/postfix/main.cf
    /etc/postfix/transport
    /etc/postfix/virtual
    /etc/postfix/vmailbox
    /etc/postfix/internal_access
    /etc/postfix/recipient_bcc
    /etc/postfix/submission_whitelist
    /etc/dovecot/dovecot.conf
    /etc/dovecot/sieve-scripts/before.sieve
);

#
# nethserver-mail-server-UPDATE event
#

event_templates('nethserver-mail-server-update', 
		@saveTemplates, 
		'/etc/dovecot/ldap.conf',
		'/etc/sysconfig/dovecot',
		'/etc/dovecot/master-users',
		'/etc/postfix/master.cf',
    );

event_actions('nethserver-mail-server-update',
	      'initialize-default-databases' => '00',
	      'nethserver-mail-server-conf' => '20',
	      'nethserver-mail-postmap-update' => '30',
	      'nethserver-mail-account-update' => '30',
	      'firewall-adjust' => '30',
	      'runlevel-adjust' => '40');

event_services('nethserver-mail-server-update',
	       'dovecot' => 'restart',
	       'postfix' => 'restart');


#
# nethserver-mail-server-SAVE event
#

event_templates('nethserver-mail-server-save', @saveTemplates);

event_actions('nethserver-mail-server-save',
	      'nethserver-mail-sieve-compile' => '20',
	      'nethserver-mail-postmap-update' => '30');

event_services('nethserver-mail-server-save',
	       'dovecot' => 'reload',
	       'postfix' => 'reload');


File::Path::make_path('root/var/lib/vmail/user', { mode => 00700 } );

#
# pseudonym-* events expand and reload postfix table templates
#

my @pseudonymTemplates = qw(
    /etc/postfix/virtual
    /etc/postfix/vmailbox
    /etc/postfix/internal_access
);

foreach (qw(create modify delete)) {
    event_templates('pseudonym-' . $_, @pseudonymTemplates);
    event_actions('pseudonym-'   . $_, 
		  'nethserver-mail-postmap-update' => '30',
		  'nethserver-mail-sync-ldap' => '30',
	);
    event_services('pseudonym-'  . $_, 'postfix' => 'reload');
}


#
# user-* events expand and reload postfix table templates
#

my @userTemplates = @pseudonymTemplates;

foreach (qw(create modify delete)) {
    event_templates('user-' . $_, @userTemplates);
    event_actions('user-'   . $_, 'nethserver-mail-postmap-update' => '30');
    event_services('user-'  . $_, 'postfix' => 'reload');
}

event_actions('user-create',
	      'nethserver-mail-pseudonym-create' => '03',
              'nethserver-mail-account-update' => '30');

event_actions('user-modify',
              'nethserver-mail-account-update' => '30');

event_actions('user-delete',
	      'nethserver-mail-pseudonym-delete' => '03',
	      'nethserver-mail-account-cleanup' => '30');


#
# group-* events expand and reload postfix table templates
#

my @groupTemplates = @pseudonymTemplates;

foreach (qw(create modify delete)) {
    event_templates('group-' . $_, @groupTemplates);
    event_actions('group-'   . $_, 
		  'nethserver-mail-postmap-update' => '30');
    event_services('group-'  . $_, 'postfix' => 'reload');
}

event_actions('group-create',
	      'nethserver-mail-pseudonym-create' => '03',
	      'nethserver-mail-account-update' => '30',
	      'nethserver-mail-group-acl-adjust' => '95');

event_actions('group-modify',
	      'nethserver-mail-account-update' => '30',
	      'nethserver-mail-group-acl-adjust' => '95');

event_actions('group-delete',
	      'nethserver-mail-pseudonym-delete' => '03',
	      'nethserver-mail-group-acl-cleanup' => '03',
	      'nethserver-mail-account-cleanup' => '30');


#
# domain-* events: expand recipient_bcc map
#
foreach (qw(create delete modify)) {
    event_templates('domain-' . $_, 
		    '/etc/postfix/recipient_bcc', 
		    '/etc/postfix/virtual',
		    '/etc/postfix/vmailbox');
    event_actions('domain-'   . $_, 'nethserver-mail-postmap-update' => '30');
}

