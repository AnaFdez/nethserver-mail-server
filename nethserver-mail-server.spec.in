Summary: Mail server implementation based on postfix and dovecot packages
Name: nethserver-mail-server
Version: @@VERSION@@
Release: @@RELEASE@@
License: GPL
URL: %{url_prefix}/%{name} 
Source0: %{name}-%{version}.tar.gz
BuildArch: noarch

Requires: dovecot >= 2.0.9, dovecot-pigeonhole >= 2.0.9, dovecot-antispam >= 0.0.48
Requires: nethserver-mail-common >= 1.0.1-2
Requires: perl(Text::Unidecode)
Requires: cyrus-sasl-plain, cyrus-sasl-ldap, cyrus-sasl-ntlm, cyrus-sasl-md5

BuildRequires: perl
BuildRequires: nethserver-devtools >= 1.0.0

%description
Mail server implementation based on postfix and dovecot packages.

%prep
%setup

%build
mkdir -p root%{perl_vendorlib}
mv -v NethServer root%{perl_vendorlib}
perl createlinks

%install
rm -rf $RPM_BUILD_ROOT
(cd root; find . -depth -print | cpio -dump $RPM_BUILD_ROOT)
%{genfilelist} $RPM_BUILD_ROOT \
    --dir /var/lib/nethserver/vmail 'attr(0700,vmail,vmail)' \
    --dir /var/lib/nethserver/sieve-scripts 'attr(0770,root,vmail)' \
    > %{name}-%{version}-filelist
echo "%doc COPYING" >> %{name}-%{version}-filelist
echo "%doc migration/sync_maildirs.sh"  >> %{name}-%{version}-filelist

%clean
rm -rf $RPM_BUILD_ROOT

%pre
# ensure vmail user exists:
if ! id vmail >/dev/null 2>&1 ; then
   useradd -c 'Virtual mailboxes owner' -r -M -d /var/lib/nethserver/vmail -s /sbin/nologin vmail
fi

# add vmail group to postfix user
usermod -G vmail -a postfix

%post

%files -f %{name}-%{version}-filelist
%defattr(-,root,root)

%changelog
* Tue Mar 19 2013 Davide Principi <davide.principi@nethesis.it> - 1.2.0-1.ns6
- vmail storage moved from /var/lib/vmail into /var/lib/nethserver/vmail, removing user/ subdir. Refs #1739
- Optionally, create default user's mail addresses during user creation. #1623
- IMAP access to admin's mailbox. #1622
- Migration support. #1669 #1726
- Support domainless pseudonyms. #1665
- Create default primary mail domain record. #1530 
- /etc/sysconfig/dovecot template: fixed wrong bash syntax to close stderr descriptor. Fixes #1656 
- *.spec: use %{url_prefix} macro in URL tag; set minimum version requirements. #1654 #1653


* Thu Jan 31 2013 Davide Principi <davide.principi@nethesis.it> - 1.1.0-1.ns6
- Added postfix/SystemUserRecipientStatus prop. Refs #1635
- Removed localhost.localdomain from transport delivery table. Refs #1635
- Migrate admin's standard mailbox to vmail storage. Refs #1622
- Grant IMAP access to system users in /etc/dovecot/system-users passwd database. Refs #1622
- Dovecot certificates under nethserver-base certificate management. Refs #1634

