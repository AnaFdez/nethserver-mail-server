Summary: Mail server implementation based on postfix and dovecot packages
Name: nethserver-mail-server
Version: @@VERSION@@
Release: @@RELEASE@@
License: GPL
URL: http://dev.nethesis.it/projects/%{name}
Source0: %{name}-%{version}.tar.gz
BuildArch: noarch

Requires: dovecot >= 2.0.9, dovecot-pigeonhole >= 2.0.9, dovecot-antispam >= 0.0.48
Requires: nethserver-mail-common
Requires: perl(Text::Unidecode)
Requires: cyrus-sasl-plain, cyrus-sasl-ldap, cyrus-sasl-ntlm, cyrus-sasl-md5

BuildRequires: perl
BuildRequires: nethserver-devtools

%description
Mail server implementation based on postfix and dovecot packages.

%prep
%setup

%build
mkdir -p root%{perl_vendorlib}
mv -v NethServer root%{perl_vendorlib}
perl createlinks

%install
rm -rf $RPM_BUILD_ROOT
(cd root; find . -depth -print | cpio -dump $RPM_BUILD_ROOT)
%{genfilelist} \
    --dir /var/lib/vmail 'attr(0700,vmail,vmail)' \
    --dir /var/lib/vmail/user 'attr(0700,vmail,vmail)' \
    $RPM_BUILD_ROOT \
    > %{name}-%{version}-filelist
echo "%doc COPYING" >> %{name}-%{version}-filelist

%clean
rm -rf $RPM_BUILD_ROOT

%pre
source /etc/nethserver/rpm_hook_functions
# ensure vmail user exists:
if ! id vmail >/dev/null 2>&1 ; then
   useradd -c 'Virtual mailboxes owner' -r -d /var/lib/vmail/ -s /sbin/nologin vmail
fi

# add vmail group to postfix user
usermod -G vmail -a postfix


%post
source /etc/nethserver/rpm_hook_functions
event_queue add %{name}-update

%preun
source /etc/nethserver/rpm_hook_functions
signal_event %{name}-uninstall


%files -f %{name}-%{version}-filelist
%defattr(-,root,root)

%changelog
* Thu Jan 31 2013 Davide Principi <davide.principi@nethesis.it> - 1.1.0-1.ns6
- Added postfix/SystemUserRecipientStatus prop. Refs #1635
- Removed localhost.localdomain from transport delivery table. Refs #1635
- Migrate admin's standard mailbox to vmail storage. Refs #1622
- Grant IMAP access to system users in /etc/dovecot/system-users passwd database. Refs #1622
- Dovecot certificates under nethserver-base certificate management. Refs #1634

